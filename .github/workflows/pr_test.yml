name: Testing PrestaShop pull requests
on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: Pull request Id
        required: true
      base_branch:
        type: choice
        description: Base branch to rebase the PR
        required: true
        options:
          - 'develop'
          - '8.1.x'
          - '8.0.x'
        default: 'develop'
      ps_mode_dev:
        type: choice
        description: Enable/Disable the developer mode 
        required: true
        options:
          - 'true'
          - 'false'
        default: 'false'
      rebase_or_merge:
        type: choice
        required: true
        description: Rebase or merge the pull request
        options:
          - 'rebase'
          - 'merge'
        default: 'rebase'
      php_version:
        type: choice
        description: PHP version
        required: true
        options:
          - '7.3'
          - '7.4'
          - '8.0'
          - '8.1'
          - '8.2'
        default: '7.4'
      node_version:
        type: choice
        description: Node version
        required: true
        options:
          - '14'
          - '16'
        default: '14'

jobs:
  testing-pr:
    runs-on: ubuntu-latest
    name: test
    strategy:
      fail-fast: false
      matrix:
        TEST_COMMAND:
          - 'cldr'
          - 'sanity'
          - 'sanity:productV2'
          - 'functional:BO:login'
          - 'functional:BO:dashboard'
          - 'functional:BO:orders:01-0*1*'
          - 'functional:BO:orders:01-create-orders'
          - 'functional:BO:orders:01-view-and-edit-order'
          - 'functional:BO:orders:02'
          - 'functional:BO:orders:03-05'
          - 'functional:BO:catalog:01-02'
          - 'functional:BO:catalog:03-04'
          - 'functional:BO:catalog:05-06'
          - 'functional:BO:catalog:07-08'
          - 'functional:BO:customer:01'
          - 'functional:BO:customer:02-03'
          - 'functional:BO:customer-service'
          - 'functional:BO:modules'
          - 'functional:BO:design'
          - 'functional:BO:shipping'
          - 'functional:BO:payment'
          - 'functional:BO:international:01'
          - 'functional:BO:international:02'
          - 'functional:BO:international:03-04'
          - 'functional:BO:shop-parameters:01-02'
          - 'functional:BO:shop-parameters:03-04'
          - 'functional:BO:shop-parameters:05-07'
          - 'functional:BO:advanced-parameters:01-06'
          - 'functional:BO:advanced-parameters:07-10'
          - 'functional:BO:header'
          - 'functional:FO:01-03'
          - 'functional:FO:04-07'
          - 'functional:FO:08-12'
          - 'functional:FO:classic:01-03'
          - 'functional:FO:classic:04-07'
          - 'functional:FO:classic:08-12'
          - 'functional:FO:hummingbird:01-03'
          - 'functional:productV2'
          - 'functional:API'
          - 'regression'
        BASE_BRANCH:
          - ${{ github.event.inputs.base_branch }}
        exclude:
          ## 8.0.x
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'cldr'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:BO:dashboard'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:productV2'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:API'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:FO:classic:01-03'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:FO:classic:04-07'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:FO:classic:08-12'
          - BASE_BRANCH: 8.0.x
            TEST_COMMAND: 'functional:FO:hummingbird:01-03'
          ## 8.1.x
          - BASE_BRANCH: 8.1.x
            TEST_COMMAND: 'functional:FO:01-03'
          - BASE_BRANCH: 8.1.x
            TEST_COMMAND: 'functional:FO:04-07'
          - BASE_BRANCH: 8.1.x
            TEST_COMMAND: 'functional:FO:08-12'
          ## develop
          - BASE_BRANCH: develop
            TEST_COMMAND: 'functional:FO:01-03'
          - BASE_BRANCH: develop
            TEST_COMMAND: 'functional:FO:04-07'
          - BASE_BRANCH: develop
            TEST_COMMAND: 'functional:FO:08-12'

    env:
      PR_NUMBER: ${{ github.event.inputs.pr_number }}
      BASE_BRANCH: ${{ github.event.inputs.base_branch }}
      PS_MODE_DEV: ${{ github.event.inputs.ps_mode_dev }}
      PHP_VERSION: ${{ github.event.inputs.php_version }}
      NODE_VERSION: ${{ github.event.inputs.node_version }}
      REBASE_OR_MERGE: ${{ github.event.inputs.rebase_or_merge }}
      PS_DIR: 'my_prestashop'

    steps:
      - name: Print Inputs values
        shell: bash
        run: echo "${{ toJSON(github.event.inputs) }}"

      - uses: actions/checkout@v3
        with:
          path: main

      - uses: actions/checkout@v3
        name: Checkout PrestaShop repository
        with:
          fetch-depth: 0
          repository: PrestaShop/PrestaShop
          path: ${{ env.PS_DIR }}

      - name: Config git
        run: |
          git config --local user.email "$(git log --format='%ae' HEAD^!)"
          git config --local user.name "$(git log --format='%an' HEAD^!)"
        working-directory: ${{ env.PS_DIR }}

      - name: Get pull request
        working-directory: ${{ env.PS_DIR }}
        run: |
          git fetch origin pull/${{ env.PR_NUMBER }}/head:pr${{ env.PR_NUMBER }}
          git checkout pr${{ env.PR_NUMBER }}

      - name: Rebase
        working-directory: ${{ env.PS_DIR }}
        if: ${{ env.REBASE_OR_MERGE == 'rebase' }}
        run: |
          git fetch origin ${{ env.BASE_BRANCH }}:${{ env.BASE_BRANCH }}
          git rebase origin/${{ env.BASE_BRANCH }}

      - name: Merge
        working-directory: ${{ env.PS_DIR }}
        if: ${{ env.REBASE_OR_MERGE == 'merge' }}
        run: |
          git fetch origin ${{ env.BASE_BRANCH }}:${{ env.BASE_BRANCH }}
          git merge origin/${{ env.BASE_BRANCH }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, intl, gd, xml, dom, json, fileinfo, curl, zip, iconv, simplexml, pdo, mysql
      
      - name: Setup MkCert
        run: |
          ## Install MkCert
          sudo apt install libnss3-tools
          curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
          chmod +x mkcert-v*-linux-amd64
          sudo cp mkcert-v*-linux-amd64 /usr/local/bin/mkcert
          ## Generate certificate
          mkcert localhost
          ## Link certificate to Chrome Trust Store
          mkdir -p $HOME/.pki/nssdb 
          certutil -d $HOME/.pki/nssdb -N 
          certutil -d sql:$HOME/.pki/nssdb -n localhost -A -t "TCu,Cu,Tu" -i ./localhost.pem
          ## Add self-signed certificate to Chrome Trust Store
          mkcert -install

      - name: Setup Apache
        run: sudo bash scripts/apache/setup.sh ${{ github.workspace }} ${{ env.PS_DIR }} ${{ env.PHP_VERSION }}
        working-directory: main

      - name: Setup mailutils
        run: sudo apt-get install -y apt-utils mailutils

      - name: Setup MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '5.7'
          mysql database: 'prestashop'
          mysql root password: 'password'

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup NPM
        run: npm install -g npm@7

      - name: Get Composer Cache Directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-
            
      - name: Cache node Directory
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('admin-dev/**/package-lock.json', 'tests/**/package-lock.json', 'themes/**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: PrestaShop Configuration (Copy of Parameters)
        if: (env.BASE_BRANCH == '8.0.x')
        run: cp ./main/scripts/php/parameters.yml ./${{ env.PS_DIR }}/app/config/parameters.yml

      - name: PrestaShop Configuration (Copy of defines_custom.inc.php)
        run: cp ./main/scripts/php/defines_custom.inc.php ./${{ env.PS_DIR }}/config/defines_custom.inc.php

      - name: PrestaShop Configuration (Set the developer mode)
        run: sed -i -e "s/APP_DEBUG/${{ env.PS_MODE_DEV}}/g" ./${{ env.PS_DIR }}/config/defines_custom.inc.php

      # Workaround until https://github.com/PrestaShop/PrestaShop/issues/29813 is fixed
      - name: PrestaShop Configuration (Copy of Config API)
        if: (env.BASE_BRANCH == '8.1.x') || (env.BASE_BRANCH == 'develop')
        run: cp ./${{ env.PS_DIR }}/app/config/security_test.yml ./${{ env.PS_DIR }}/app/config/security_prod.yml

      - name: Composer install and build assets
        run: make
        working-directory: ${{ env.PS_DIR }}

      - name: Install PrestaShop
        if: (matrix.TEST_COMMAND != 'sanity')
        run: |
          php install-dev/index_cli.php \
          --language=en --country=fr --domain=localhost \
          --db_server=127.0.0.1 --db_password=password --db_name=prestashop --db_create=1 --prefix=tst_ \
          --firstname="Marc" --lastname="Beier" --email=demo@prestashop.com \
          --ssl=1
        working-directory: ${{ env.PS_DIR }}

      - name: Enable sessions for Apache2
        run: |
          sudo chmod 777 -R ${{ github.workspace }}
          sudo mkdir -p /var/lib/php/sessions
          sudo chown www-data:www-data /var/lib/php/sessions
          sudo service apache2 restart

      - name: Install tests dependencies
        run: npm install
        working-directory: '${{ env.PS_DIR }}/tests/UI'

      - name: Run tests
        id: run_tests
        run: npm run test:${{ matrix.TEST_COMMAND }}
        working-directory: '${{ env.PS_DIR }}/tests/UI'
        env:
          URL_FO: https://localhost/
          DB_NAME: prestashop
          DB_PASSWD: password
          HEADLESS: true
          TAKE_SCREENSHOT_AFTER_FAIL: true

      - run: echo "MY_COMMAND=$( echo -e '${{ matrix.TEST_COMMAND }}' | tr  ':' '-'  )" >> $GITHUB_ENV
        if: ${{ always() }}

      - uses: actions/upload-artifact@v3
        if: ${{ always() }}
        with:
          name: screenshots-${{ env.MY_COMMAND }}
          path: '${{ env.PS_DIR }}/tests/UI/screenshots/'
