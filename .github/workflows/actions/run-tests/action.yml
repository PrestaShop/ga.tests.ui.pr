name: Run UI tests
description: Run UI tests
inputs:
  repository_ref:
    description: Base branch/ref from the repository
    required: true
  ps_mode_dev:
    description: Enable/Disable the developer mode
    required: true
  php_version:
    description: PHP version
    required: true
  node_version:
    description: Node version
    required: true
  test_command:
    description: Test command to run
    required: true
  fast_fail:
    description: Fast fail on first error
    required: true
  ps_dir:
    description: Directory target
    required: true

runs:
  using: "composite"
  steps:
    - name: Run tests
      run: |
        export NODE_EXTRA_CA_CERTS="$(mkcert -CAROOT)/rootCA.pem"
        npm run test:${{ inputs.test_command }}
      working-directory: '${{ inputs.ps_dir }}/tests/UI'
      env:
        # Input values
        PS_MODE_DEV: ${{ fromJson(inputs.ps_mode_dev) && '1' || '0' }}
        PS_DEV_MODE: ${{ fromJson(inputs.ps_mode_dev) && '1' || '0' }}
        PHP_VERSION: ${{ inputs.php_version }}
        NODE_VERSION: ${{ inputs.node_version }}
        VERSION: ${{ inputs.php_version }}-apache
        PS_DOMAIN: ${{ (startsWith(inputs.repository_ref, '8.0') || startsWith(inputs.repository_ref, '1.7')) && 'localhost:8001' || 'localhost:8002' }}
        PS_ENABLE_SSL: ${{ (startsWith(inputs.repository_ref, '8.0') || startsWith(inputs.repository_ref, '1.7')) && '0' || '1' }}
        ADMIN_PASSWD: ${{ startsWith(inputs.repository_ref, '1.7') && 'prestashop_demo' || 'Correct Horse Battery Staple' }}
        # Fixed values
        DB_USER: root
        DB_PASSWD: prestashop
        DB_NAME: prestashop
        DB_PREFIX: tst_
        DB_SERVER: mysql
        PS_FOLDER_INSTALL: install-dev
        PS_FOLDER_ADMIN: admin-dev
        PS_COUNTRY: fr
        PS_LANGUAGE: en
        ADMIN_MAIL: 'demo@prestashop.com'
        # Test variables
        URL_FO: ${{ (startsWith(inputs.repository_ref, '8.0') || startsWith(inputs.repository_ref, '1.7')) && 'http://localhost:8001/' || 'https://localhost:8002/' }}
        HEADLESS: true
        ENABLE_SSL: true
        TAKE_SCREENSHOT_AFTER_FAIL: true
        SMTP_SERVER: '172.17.0.1'
        EXTRA_TEST_PARAMS: ${{ fromJson(inputs.fast_fail) && '--bail' || '' }}
      shell: bash

    # UI Tests : Upload screenshots
    - name: Prepare screenshot name
      id: screenshot-campaign
      run: echo "screenshot-campaign=$( echo -e '${{ inputs.test_command }}' | tr ':' '-' )" >> $GITHUB_OUTPUT
      if: failure()
      shell: bash

    # Export screenshots in case of failure
    - name: Export screenshots as artifacts
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: screenshots-campaign-${{ steps.screenshot-campaign.outputs.screenshot-campaign }}
        path: |
          ${{ inputs.ps_dir }}/tests/UI/screenshots/
